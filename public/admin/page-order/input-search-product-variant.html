<link rel="import" href="part-items-pages.html">
<dom-module id="input-search-product-variant">
  <template>
  <style include="style-form"></style>
    <style>
      .items {
        display: none;
      }
      .items[show] {
        display: block;
      }
      input {
        box-sizing: border-box;
      }
    </style>

   <form id="form" class="form" on-submit="on_submit">
      <div class="field">
        <label class="label">[[order_item_product_variant_label]]</label>
        <input is="iron-input" class="form-control" type="text" bind-value="{{name}}"
          on-keyup="on_search_variant" on-focus="on_search_variant">
      </div>
    </form>

    <div show$="{{show}}">
      <template id="items" is="dom-repeat" items="{{items}}" as="item" filter="filter_variant">
        <div class="item" on-click="on_click_select">
          <span>{{item.name}}</span>
        </div>
      </template>
    </div>

    <part-items-pages on-change-page="on_change_page" perpage="{{perpage}}" count="{{count}}">

  </template>
</dom-module>
<script>
  Polymer({

    is: 'input-search-product-variant',

    properties: {
      order_item_product_variant_label: {
        type: String,
        value: 'Variant'
      },
      items: {
        type: Array,
        value: function () { return []; },
        observer: '_on_change_items'
      },
      name: {
        type: String,
        value: ''
      },
      selected: {
        type: Object,
        notify: true,
        value: function () { return {}; }
      },
      show: {
        type: Boolean,
        value: false
      },
      id_selected_variant: {
        type: String,
        notify: true,
        value: ''
      },
      count: {
        type: Number
      },
      perpage: {
        type: Number,
        value: 2
      },
      list: {
        type: Array,
        value: function () { return []; }
      },
    },

    _on_change_items: function () {
      if (!this.items) {
        this.count = 0;
        return;
      }
      this.count = this.items.length;
      this.clone_items();
      this.set('items' , this.items.slice(0, this.perpage));
    },

    on_search_variant: function (event) {
      event.stopPropagation();
      if (!this.items) {
        return;
      }
      this.clone_items();
      this.set('show', true);
      if (this.name.length === 0) {
        this.set('items' , this.items.slice(0, this.perpage));
      }
      this.set('items', this.get_filter_variant());
    },

    clone_items: function () {
      if (this.list.length === 0 && this.items.length !== 0) {
        this.list = JSON.parse(JSON.stringify(this.items));
        this.list.sort(function (item_a, item_b) {
          if (item_a.name < item_b.name)
            return -1;
          if (item_a.name > item_b.name)
            return 1;
          return 0;
        });
        this.items = this.list;
      }
    },

    get_filter_variant: function () {
      return this.items.filter(function (item) {
        return item.name.search(this.name) >= 0;
      }, this);
    },

    on_change_page: function (event) {
      event.stopPropagation();
      this.items = this.list;
      if (!this.items) {
        return;
      }
      var page = event.detail.current -1;
      var skip = page ? page * this.perpage : 0;
      if (skip == 0) {
        this.set('items', this.items.slice(0, this.perpage));
        return;
      }
      this.set('items', this.items.slice(skip));
    },

    on_click_select: function (event) {
      event.stopPropagation();
      this.set('show', false);
      var item = this.$.items.itemForElement(event.target);
      this.id_selected_variant = item.id;
      this.selected = item;
      this.name = item.name;
      this.fire('selected-variant');
    },

    filter_variant: function (item) {
      return item.name.search(this.name) >= 0;
    },

    clear: function () {
      this.set('name', '');
    },

    on_submit: function (event) {
      event.stopPropagation();
      event.preventDefault();
    }

  });
</script>