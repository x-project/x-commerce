<link rel="import" href="/components/api-model/api-model.html">
<link rel="import" href="../input-errors/input-errors.html">
<link rel="import" href="../style-form/style-form.html">
<dom-module id="form-order-customer">
  <template>
   <style include="style-form"></style>
   <style>
    input {
      box-sizing: border-box;
    }
   </style>

    <api-model-find id="find" collection="customers" response="{{customers}}"></api-model-find>
    <api-model-update id="update" collection="orders" model-id="{{order.id}}"></api-model-update>

    <form on-submit="on_sumbmit">
      <div class="field">
        <label class="label">[[order_customer_label]]</label>
        <input class="form-control" id="input" type="text" is="iron-input" bind-value="{{customer.first_name}}"
          on-keypress="on_search_customer" on-focus="on_search_customer">
      </div>
      <input-errors property="customer_id" error="{{error.details}}"></input-errors>
    </form>

    <div class="item">
      <template id="customers" is="dom-repeat" items="{{customers}}" filter="filter_customer">
        <div class="item" on-click="on_customer_selected">
          <span>{{item.first_name}}</span>
        </div>
      </template>
  </template>
</dom-module>
<script>
  Polymer({

    is: 'form-order-customer',

    properties: {
      order_customer_label: {
        type: String,
        value: 'Customer'
      },
      customers: {
        type: Array,
        value: function () { return []; }
      },
      order: {
        type: Object,
        value: function () { return {}; }
      },
      customer: {
        type: Object,
        value: function () { return {}; }
      },
      error: {
        type: Object,
        value: function () { return {}; }
      }
    },

    attached: function () {
      this.customer = this.order.customer || [];
    },

    on_sumbmit: function (event) {
      event.preventDefault();
      event.stopPropagation();
    },

    on_search_customer:  function (event) {
      event.stopPropagation();
      this.$.find.send();
    },

    filter_customer: function(customer) {
      return customer.first_name.search(this.customer.first_name)>=0;
    },

    on_customer_selected: function (event) {
      event.stopPropagation();
      var customer = this.$.customers.itemForElement(event.target);
      this.$.input.value = customer.first_name;
      this.customers = [];
      this.order.customer_id = customer.id;
      this.fire('try-save');
    },

    try_save: function (customer) {
      this.$.update.data = { customer_id: customer.id };
      this.$.update.send();
    },

    on_put_response: function (event, details) {
      event.stopPropagation();
      this.set('customers', []);
    }

  });
</script>