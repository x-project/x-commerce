<link rel="import" href="/components/api-model/api-model.html">
<link rel="import" href="../style-form/style-form.html">
<dom-module id="input-search-product">
  <template>
    <style include="style-form"></style>
    <style>
      .items {
        display: none;
      }
      .items[show] {
        display: block;
      }
      input {
        box-sizing: border-box;
      }
    </style>

    <api-model-find id="find" collection="products" response="{{products}}"
      include=["variants"]>
    </api-model-find>

    <form id="form" class="form" on-submit="on_submit">
      <div class="field">
        <label>[[order_item_product_label]]</label>
        <input is="iron-input" class="form-control" type="text" bind-value="{{title}}"
          on-keypress="on_search_product" on-focus="on_search_product">
      </div>
    </form>

    <div class="items" show$="{{show}}">
      <template id="products" is="dom-repeat" items="{{products}}" as="product"
        filter="filter_products">
        <div class="product" on-click="on_click_select">
          <span class="product">{{product.title}}</span>
        </div>
      </template>
    </div>

  </template>
</dom-module>
<script>
  Polymer({

    is: 'input-search-product',

    properties: {
      order_item_product_label: {
        type: String,
        value: 'Product'
      },
      title: {
        type: String,
        value: ''
      },
      show: {
        type: Boolean,
        value: false,
      },
      id_selected: {
        type: String,
        notify: true,
        value: ''
      },
      selected: {
        type: Object,
        notify: true,
        value: function () { return {}; }
      }
    },

    show_products: function () {
      this.set('show', true);
    },

    hide_products: function () {
      this.set('show', false);
    },

    on_search_product: function (event) {
      event.stopPropagation();
      this.show_products();
      this.$.find.send();
    },

    on_click_select: function (event) {
      event.stopPropagation();
      var product = this.$.products.itemForElement(event.target);
      this.hide_products();
      this.id_selected = product.id;
      this.selected = product;
      this.title = product.title;
      this.fire('change');
    },

    filter_products: function (product) {
      return product.title.search(this.title) >= 0;
    },

    clear: function () {
      this.set('title', '');
    }

  });
</script>