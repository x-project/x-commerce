<link rel="import" href="../style-form/style-form.html">
<dom-module id="part-order-item">
  <template>
    <style include="style-form"></style>

    <style>
      .item .delete:hover {
        opacity: .5;
      }
      .item .edit:hover {
        opacity: .5;
      }
      .item .pending {
        display: none;
      }
      .item .pending[pending] {
        display: inline-block;
      }
      input#quantity_edit {
        box-sizing: border-box;
        width: 150px;
        display: inline;
      }
    </style>

    <div class="item">
      <span>{{data.product.title}} {{data.product_variant.name}}</span>
      <input id="quantity_edit" class="form-control" readonly$="{{editing}}"
        type="number" is="iron-input" min="1" bind-value="{{data.quantity}}"
        on-keyup="on_keyup" on-change="on_change">
      <span>x $ {{data.product.price}} = $ {{subtotal}}</span>
      <span class="delete" on-click="on_click_delete">x</span>
      <span class="pending" pending$="{{pending}}">saving........</span>
    </div>

  </template>
</dom-module>
<script>
  Polymer({

    is: 'part-order-item',

    properties: {
      data: {
        type: Object,
        value: function () { return {}; }
      },
      subtotal: {
        type: Number
      },
      editing: {
        type: Boolean,
        value: true
      },
      pending: {
        type: Boolean
      }
    },

    attached: function () {
      console.log(Object.keys(this.data).length);
      if(!this.data || Object.keys(this.data).length == 0) {
        return;
      }
      this.update_subtotal();
    },

    on_change: function (event) {
      event.stopPropagation();
      this.update_subtotal();
    },

    readonly_quantity: function () {
      this.set('editing', true);
    },

    edit_quantity: function () {
      this.set('editing', false);
    },

    update_subtotal: function () {
      if(!this.data.product) {
        return;
      }
      if(this.data.hasOwnProperty('product_variant')) {
        this.subtotal = this.calculate_subtotal_variant();
        return;
      }
      this.subtotal = this.calculate_subtotal_product();
    },

    calculate_subtotal_variant: function () {
      return this.data.quantity * this.data.product_variant.price;
    },

    calculate_subtotal_product: function () {
      return this.data.quantity * this.data.product.price;
    },

    on_click_delete: function (event) {
      event.stopPropagation();
      this.fire('click-delete');
    },

    on_keyup: function (event) {
      this.update_subtotal();
      if(event.keyCode === 13) {
        this.readonly_quantity();
        this.fire('edit-order-item');
        return;
      }
    }

  });
</script>