<link rel="import" href="../style-form/style-form.html">
<link rel="import" href="input-search-product.html">
<link rel="import" href="input-search-product-variant.html">

<dom-module id="form-order-item">
  <template>
    <style include="style-form">
      .input_variants {
        display: none;
      }
      .input_variants[visible] {
        display: block;
      }
    </style>

    <iron-ajax id="ajax_post_order_item" method="POST" handle-as="json"
      content-type="application/json" on-response="on_response_post" on-error="on_error">
    </iron-ajax>

    <input-search-product id="search_product" id_selected="{{order_item.product_id}}"
      selected="{{product_selected}}" on-change="on_change_product_id">
    </input-search-product>

    <input-search-product-variant id="search_product_variant" class="input_variants"
      visible$="{{visible}}" id_selected_variant="{{order_item.variant_id}}"
      variants="{{product_selected.variants}}" selected="{{variant_selected}}">
    </input-search-product-variant>

    <div class="field">
      <label>quantity</label>
      <input is="iron-input" class="input" type="number" bind-value="{{order_item.quantity}}">
    </div>

    <div class="field">
      <input type="submit" value="save" on-click="on_click_save">
    </div>

  </template>
</dom-module>
<script>
  Polymer({

    is: 'form-order-item',

    properties: {
      order: {
        type: Object,
        value: function () { return {}; }
      },
      order_item: {
        type: Object,
        value: function () { return { quantity: 1 }; },
      },
      visible: {
        type: Boolean,
        value: false
      }
    },

    on_change_product_id: function (event) {
      event.stopPropagation();
      this.order_item.variant_id = '';
      this.set('visible', this.product_selected.variants.length > 0);
    },

    on_click_save: function (event) {
      event.stopPropagation();
      this.$.ajax_post_order_item.url = '/api/orders/' + this.order.id + '/order_items';
      this.$.ajax_post_order_item.body = JSON.stringify({
        quantity: this.order_item.quantity,
        orderId: this.order.id,
        product_id: this.order_item.product_id,
        product_variant_id: this.order_item.variant_id
      });
      this.$.ajax_post_order_item.generateRequest();
    },

    on_response_post: function (event, details) {
      event.stopPropagation();
      var order_item = details.response;

      this.$.search_product.reset_title();
      this.$.search_product_variant.reset_variant_name();
      this.reset_quantity();
      this.fire('create-order-item',Â {order_item: order_item});
    },

    reset_quantity: function () {
      this.set('order_item.quantity', 1);
    },

    on_error: function (event) {
      event.stopPropagation();
      console.log(event);
    }

  });
</script>