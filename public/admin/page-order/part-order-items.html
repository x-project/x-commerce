<link rel="import" href="part-order-item.html">
<link rel="import" href="input-search-product.html">
<link rel="import" href="input-search-product-variant.html">
<dom-module id="part-order-items">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>

    <iron-ajax id="ajax_get_order_items" method="GET" on-error="on_error"
      last-response="{{order_items}}">
    </iron-ajax>

    <iron-ajax id="ajax_get_order_item_pending" method="GET" on-error="on_error"
      last-response="{{order_items_pending}}" on-response="on_response_get_pending">
    </iron-ajax>

    <iron-ajax id="ajax_put_order_item" method="PUT" content-type="application/json"
      on-error="on_error">
    </iron-ajax>

    <iron-ajax id="ajax_delete" method="DELETE" on-error="on_error"
      on-response="on_response_delete">
    </iron-ajax>

    <h2>Order items</h2>

    <div class="items">
      <template id="order_items" is="dom-repeat" items="{{order_items}}" as="order_item">
        <part-order-item data="{{order_item}}"on-click-delete="on_click_delete"
          on-edit-order-item="on_edit_order_item">
        </part-order-item>
      </template>
        <!-- <part-order-item data="{{order_items_pending}}" editable="{{}}"></part-order-item> -->
    </div>
  </template>
</dom-module>
<script>
  Polymer({

    is: 'part-order-items',

    properties: {
      order_items: {
        type: Array,
        value: function () { return []; }
      },
      last_order_item_saving:Â {
        type: Boolean,
        value: false
      },
      order_items_pending: {
        type: Array,
        value: function () { return []; }
      }
    },

    attached: function () {
      this.update_order_items();
    },

    update_order_items: function () {
      this.$.ajax_get_order_items.url = '/api/orders/'+ this.order.id + '/order_items?filter=%7B%22include%22%3A%5B%22product%22%2C%22product_variant%22%5D%7D'
      this.$.ajax_get_order_items.generateRequest();
    },

    order_item_pending: function (order_item) {
      this.$.ajax_get_order_item_pending.url = '/api/order_items/'+ order_item.id + '?filter=%7B%22include%22%3A%5B%22product%22%2C%20%22product_variant%22%5D%7D';
      this.$.ajax_get_order_item_pending.generateRequest();
    },

    on_response_get_pending: function (event) {
      event.stopPropagation();
      this.async(function () {
        this.update_order_items();
      }, 1000);
    },

    on_click_delete: function () {
      var order_item = this.$.order_items.itemForElement(event.target);
      this.$.ajax_delete.url = '/api/orders/' + order_item.orderId + '/order_items/' + order_item.id;
      this.$.ajax_delete.generateRequest();
    },

    on_response_delete: function (event) {
      event.stopPropagation();
      this.update_order_items();
    },

    on_edit_order_item: function (event) {
      event.stopPropagation();
      var data = this.$.order_items.itemForElement(event.target);
      this.$.ajax_put_order_item.url = '/api/orders/' + data.orderId + '/order_items/' + data.id;
      var order_item = {
        quantity: data.quantity,
        orderId: data.orderId,
        product_id: data.product_id,
        product_variant_id: data.product_variant_id
      };
      this.$.ajax_put_order_item.body = JSON.stringify(order_item);
      this.$.ajax_put_order_item.generateRequest();
    },

    on_error: function (event) {
      event.stopPropagation();
      console.log(event);
    }

  });
</script>