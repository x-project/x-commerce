<link rel="import" href="/components/api-model/api-model.html">
<link rel="import" href="part-order-item.html">
<link rel="import" href="input-search-product.html">
<link rel="import" href="input-search-product-variant.html">
<dom-module id="part-order-items">
  <template>
    <style>
      :host {
        display: block;
      }
      .items .pending {
        display: none;
      }
      .items .pending[pending] {
        display: block;
      }
    </style>

    <api-model-find id="find" collection="orders" response="order_items"
      model-id="order.id"></api-model-find>

    <iron-ajax id="ajax_get_order_items" method="GET" on-error="on_error"
      last-response="{{order_items}}">
    </iron-ajax>

    <iron-ajax id="ajax_put_order_item" method="PUT" content-type="application/json"
      on-error="on_error">
    </iron-ajax>

    <iron-ajax id="ajax_post_order_item" method="POST" handle-as="json"
      content-type="application/json" on-response="on_response_post" on-error="on_error">
    </iron-ajax>

    <iron-ajax id="ajax_delete" method="DELETE" on-error="on_error"
      on-response="on_response_delete">
    </iron-ajax>

    <h2>Order items</h2>

    <div class="items">
      <template id="order_items" is="dom-repeat" items="{{order_items}}" as="order_item">
        <part-order-item data="{{order_item}}" on-click-delete="on_click_delete"
          on-edit-order-item="on_edit_order_item">
        </part-order-item>
      </template>
        <part-order-item class="pending" data="{{order_item_pending}}"
          pending$="{{pending}}"></part-order-item>
    </div>
  </template>
</dom-module>
<script>
  Polymer({

    is: 'part-order-items',

    properties: {
      order: {
        type: Object,
        value: function () { return {}; }
      },
      last_order_item_saving: {
        type: Boolean,
        value: false
      },
      order_item_pending: {
        type: Object,
        value: function () { return {}; }
      },
      pending: {
        type: Boolean,
        value: false
      }
    },

    attached: function () {
      this.update_order_items();
    },

    show_saved: function () {
      this.set('saved', true);
    },

    hide_saved: function () {
      this.set('saved', false);
    },

    show_pending: function () {
      this.set('pending', true);
    },

    hide_pending: function () {
      this.set('pending', false);
    },

    update_order_items: function () {
      this.$.ajax_get_order_items.url = '/api/orders/'+ this.order.id + '/order_items?filter=%7B%22include%22%3A%5B%22product%22%2C%22product_variant%22%5D%7D'
      this.$.ajax_get_order_items.generateRequest();
      this.set('order_item_pending', {});
    },

    selected_pending: function (test) {
      this.show_pending();
      this.order_item_pending = test;
      this.request_post(test);
    },

    request_post: function (test) {
      this.$.ajax_post_order_item.url = '/api/orders/' + this.order.id + '/order_items';
      this.$.ajax_post_order_item.body = JSON.stringify(this.get_order_item(test));
      this.async(function () {
        this.$.ajax_post_order_item.generateRequest();
      }, 3000);
    },

    get_order_item: function (test) {
      return {
        quantity: test.quantity,
        orderId: this.order.id,
        product_id: test.product_id,
        product_variant_id: test.variant_id
      };
    },

    on_response_post: function (event) {
      event.stopPropagation();
      this.hide_pending();
      this.update_order_items();
    },

    on_click_delete: function () {
      var order_item = this.$.order_items.itemForElement(event.target);
      this.$.ajax_delete.url = '/api/orders/' + order_item.orderId + '/order_items/' + order_item.id;
      this.$.ajax_delete.generateRequest();
    },

    on_response_delete: function (event) {
      event.stopPropagation();
      this.update_order_items();
    },

    on_edit_order_item: function (event) {
      event.stopPropagation();
      var data = this.$.order_items.itemForElement(event.target);
      this.$.ajax_put_order_item.url = '/api/orders/' + data.orderId + '/order_items/' + data.id;
      var order_item = {
        quantity: data.quantity,
        orderId: data.orderId,
        product_id: data.product_id,
        product_variant_id: data.product_variant_id
      };
      this.$.ajax_put_order_item.body = JSON.stringify(this.order_item);
      this.$.ajax_put_order_item.generateRequest();
    },

    on_error: function (event) {
      event.stopPropagation();
      console.log(event);
    }

  });
</script>