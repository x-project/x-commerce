<link rel="import" href="/components/app-routes/app-routes.html">
<link rel="import" href="/components/app-route/app-route.html">
<link rel="import" href="/components/app-container/app-container.html">
<link rel="import" href="/components/app-link/app-link.html">
<link rel="import" href="/components/app-session/app-session.html">
<link rel="import" href="/components/iron-ajax/iron-ajax.html">
<link rel="import" href="../app-theme/app-theme.html">
<link rel="import" href="../page-home/page-home.html">
<link rel="import" href="../page-collections/page-collections.html">
<link rel="import" href="../page-collection/page-collection.html">
<link rel="import" href="../page-orders/page-orders.html">
<link rel="import" href="../page-order/page-order.html">
<link rel="import" href="../page-products/page-products.html">
<link rel="import" href="../page-product/page-product.html">
<link rel="import" href="../page-customers/page-customers.html">
<link rel="import" href="../page-customer/page-customer.html">
<link rel="import" href="../page-variants/page-variants.html">
<link rel="import" href="../page-variant/page-variant.html">

<link rel="import" href="../page-test/page-test.html">
<dom-module id="app-boot">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>

    <app-session id="session"></app-session>

    <app-container id="app" on-login="on_login" on-logout="on_logout"></app-container>

    <app-routes id="routes" on-route="on_route">
      <app-route path="/admin" page="page-home"></app-route>
      <app-route path="/admin/" page="page-home"></app-route>
      <app-route path="/admin/collections" page="page-collections"></app-route>
      <!-- <app-route path="/admin/collections/new" page="page-collection"></app-route> -->
      <app-route path="/admin/collections/:collection_id" page="page-collection"
        on-route="/admin/collections/:collection_id"></app-route>
      <app-route path="/admin/orders" page="page-orders"></app-route>
      <!-- <app-route path="/admin/orders/new" page="page-order"></app-route> -->
      <app-route path="/admin/orders/:order_id" page="page-order"
        on-route="/admin/orders/:order_id"></app-route>


      <app-route path="/admin/products" page="page-products"></app-route>
      <app-route path="/admin/products/new" page="page-product"
        on-route="/admin/products/:product_id">
      </app-route>
      <app-route path="/admin/products/:product_id" page="page-product"
        on-route="/admin/products/:product_id"></app-route>


      <app-route path="/admin/customers" page="page-customers"></app-route>
      <!-- <app-route path="/admin/customers/new" page="page-customer"></app-route> -->
      <app-route path="/admin/customers/:customer_id" page="page-customer"
        on-route="/admin/customers/:customer_id"></app-route>
       <!--varianti di un prodotto-->
      <app-route path="/admin/products/:product_id/variants" page="page-variants"
        on-route="/admin/products/:product_id/variants">
      </app-route>
      <!--scheda variante-->
      <app-route path="/admin/products/:product_id/variants/:variant_id" page="page-variant"
        on-route="/admin/products/:product_id/variants/:variant_id">
      </app-route>

      <app-route path="/admin/test" page="page-test"></app-route>
    </app-routes>

  </template>
</dom-module>
<script>
  Polymer({

    is: 'app-boot',

    properties: {
      user: {
        type: Object
      }
    },

    on_route: function (event) {
      this.user = this.$.session.get('user');
    },

    on_login: function (event) {
      this.$.session.set('user', event.detail.user);
    },

    on_logout: function (event) {
      this.$.session.unset('user');
    },

    '/login': function (event) {
      if (this.user) {
        event.stopPropagation();
        page('/');
        return;
      }
    },

    '/admin/products/:product_id': function (event) {
      event.stopPropagation();
      var routes = this.$.routes;
      if(this.is_new_model(event)){
        event.detail.data = { product: undefined };
        routes.fire('route', event.detail);
        return;
      }
      else{
        var model_id = event.detail.params.product_id;
        this.get_model('Products', model_id, function (err, model) {
          if (err) {
            page('/404');
            return;
          }
          event.detail.data = { product: model };
          routes.fire('route', event.detail);
        });
      }
    },

    '/admin/collections/:collection_id': function (event) {
      event.stopPropagation();
      var routes = this.$.routes;
      if(this.is_new_model(event)){
        event.detail.data = { collection: undefined };
        routes.fire('route', event.detail);
        return;
      }
      else{
        var model_id = event.detail.params.collection_id;
        this.get_model('Collections', model_id, function (err, model) {
          if (err) {
            page('/404');
            return;
          }
          event.detail.data = { collection: model };
          routes.fire('route', event.detail);
        });
      }
    },

    '/admin/orders/:order_id': function (event) {
      event.stopPropagation();
      var routes = this.$.routes;
      if(this.is_new_model(event)){
        event.detail.data = { order: undefined };
        routes.fire('route', event.detail);
        return;
      }
      else{
        var model_id = event.detail.params.order_id;
        this.get_model('Orders', model_id, function (err, model) {
          if (err) {
            page('/404');
            return;
          }
          event.detail.data = { order: model };
          routes.fire('route', event.detail);
        });
      }
    },

    '/admin/customers/:customer_id': function (event) {
      event.stopPropagation();
      var routes = this.$.routes;
      if(this.is_new_model(event)){
        event.detail.data = { customer: undefined };
        routes.fire('route', event.detail);
        return;
      }
        else{
        var model_id = event.detail.params.customer_id;
        this.get_model('Customers', model_id, function (err, model) {
          if (err) {
            page('/404');
            return;
          }
          event.detail.data = { customer: model };
          routes.fire('route', event.detail);
        });
      }
    },

    '/admin/products/:product_id/variants': function (event) {
      event.stopPropagation();
      var model_id = event.detail.params.product_id;
      var routes = this.$.routes;

      this.get_model('Products', model_id, function (err, model) {
        if (err) {
          page('/404');
          return;
        }
        event.detail.data = { product: model };
        routes.fire('route', event.detail);
      });
    },

    '/admin/products/:product_id/variants/:variant_id': function (event) {
      event.stopPropagation();
      var routes = this.$.routes;
      var product_id = event.detail.params.product_id;
      var variant_id = event.detail.params.variant_id;
      this.get_model('Products', product_id, function (err, model) {
        if (err) {
          page('/404');
          return;
        }
        event.detail.data_product = { product: model };
      });
      this.get_model('ProductVariants', variant_id, function (err, model) {
        if (err) {
          page('/404');
          return;
        }
        event.detail.data_variant = { variant: model };
        routes.fire('route', event.detail);
      });
    },

    get_model: function (model, model_id, callback) {
      var ajax = document.createElement('iron-ajax');

      var on_error = function () {
        var err = ajax.lastError;
        callback(err, null);
      };

      var on_response = function () {
        var response = ajax.lastResponse;
        callback(null, response);
      };

      ajax.url = '/api/'+ model +'/'+ model_id;
      ajax.method = 'GET';
      ajax.handleAs = 'json';
      ajax.addEventListener('response', on_response, false);
      ajax.addEventListener('error', on_error, false);
      ajax.generateRequest();
    },

    is_new_model: function (event) {
      var path_splitted = event.detail.path.split('/');
      var model_new = path_splitted[3];
      if(model_new === 'new')
        return true;
      return false;
    }

  });
</script>