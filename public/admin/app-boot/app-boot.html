<link rel="import" href="/components/app-routes/app-routes.html">
<link rel="import" href="/components/app-route/app-route.html">
<link rel="import" href="/components/app-container/app-container.html">
<link rel="import" href="/components/app-link/app-link.html">
<link rel="import" href="/components/app-session/app-session.html">
<link rel="import" href="/components/api-model-get/api-model-get.html">
<link rel="import" href="/components/api-model-find/api-model-find.html">
<link rel="import" href="../app-theme/app-theme.html">
<link rel="import" href="../page-home/page-home.html">
<link rel="import" href="../page-collections/page-collections.html">
<link rel="import" href="../page-collection/page-collection.html">
<link rel="import" href="../page-orders/page-orders.html">
<link rel="import" href="../page-order/page-order.html">
<link rel="import" href="../page-products/page-products.html">
<link rel="import" href="../page-product/page-product.html">
<link rel="import" href="../page-customers/page-customers.html">
<link rel="import" href="../page-customer/page-customer.html">
<link rel="import" href="../page-store/page-store.html">
<link rel="import" href="../page-variants/page-variants.html">
<link rel="import" href="../page-variant/page-variant.html">

<link rel="import" href="../page-invite/page-invite.html">
<link rel="import" href="../page-login/page-login.html">
<link rel="import" href="../page-member/page-member.html">
<link rel="import" href="../page-signup/page-signup.html">
<link rel="import" href="../page-team/page-team.html">

<link rel="import" href="../page-test/page-test.html">
<dom-module id="app-boot">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>

    <app-session id="session"></app-session>

    <app-container id="app" on-login="on_login" on-logout="on_logout"></app-container>

    <app-routes id="routes" on-route="on_route">

      <app-route path="/admin" page="page-login"></app-route>
      <app-route path="/admin/" page="page-login"></app-route>

      <app-route path="/admin/store" page="page-store"
        on-route="/admin/store"></app-route>
      <app-route path="/admin/collections" page="page-collections"></app-route>
      <app-route path="/admin/collections/new" page="page-collection"
        on-route="/admin/collections/new">
      </app-route>
      <app-route path="/admin/collections/:collection_id" page="page-collection"
        on-route="/admin/collections/:collection_id"></app-route>

      <app-route path="/admin/orders" page="page-orders"></app-route>
      <app-route path="/admin/orders/new" page="page-order"
        on-route="/admin/orders/new">
      </app-route>
      <app-route path="/admin/orders/:order_id" page="page-order"
        on-route="/admin/orders/:order_id"></app-route>

      <app-route path="/admin/products" page="page-products"></app-route>
      <app-route path="/admin/products/new" page="page-product"
        on-route="/admin/products/new">
      </app-route>
      <app-route path="/admin/products/:product_id" page="page-product"
        on-route="/admin/products/:product_id"></app-route>
      <app-route path="/admin/customers" page="page-customers"></app-route>
      <app-route path="/admin/customers/new" page="page-customer"
        on-route='/admin/customers/new'></app-route>
      <app-route path="/admin/customers/:customer_id" page="page-customer"
        on-route="/admin/customers/:customer_id"></app-route>
       <!--varianti di un prodotto-->
      <app-route path="/admin/products/:product_id/variants" page="page-variants"
        on-route="/admin/products/:product_id/variants">
      </app-route>
      <!--scheda variante-->
      <app-route path="/admin/products/:product_id/variants/:variant_id" page="page-variant"
        on-route="/admin/products/:product_id/variants/:variant_id">
      </app-route>



      <app-route path="/admin/invite/new" page="page-invite"></app-route>
      <app-route path="/admin/login" page="page-login"></app-route>
      <app-route path="/admin/members/:member_id" page="page-member"></app-route>
      <app-route path="/admin/signup" page="page-signup"></app-route>
      <app-route path="/admin/team" page="page-team"></app-route>

      <app-route path="/admin/test" page="page-test"></app-route>
    </app-routes>

  </template>
</dom-module>
<script>


  Polymer({

    is: 'app-boot',

    properties: {
      user: {
        type: Object
      }
    },

    attached: function (event) {
      this.user = this.$.session.get('user');
      this.isAdmin = this.user ? this.user.role === 'admin' : false;
      this.accessToken = this.$.session.get('access_token');
    },

   on_route: function (event) {
      event.detail.session = {
        accessToken: this.accessToken,
        isAdmin: this.isAdmin,
        user: this.user,
      };
    },

    on_login: function (event) {
      this.$.session.set('access_token', event.detail.id);
      this.$.session.set('user_id', event.detail.userId);
      this.$.session.set('user', event.detail.user);
      this.user = event.detail.user;
      this.accessToken = event.detail.id;
      this.isAdmin = this.user.role === 'admin';
      page('/admin/team');
    },

    on_logout: function (event) {
      this.$.session.unset('access_token');
      this.$.session.unset('user_id');
      this.$.session.unset('user');
      delete this.accessToken;
      delete this.isAdmin;
      delete this.user;
    },

    '/login': function (event) {
      if (this.user) {
        event.stopPropagation();
        page('/');
        return;
      }
    },

    '/admin/store': function () {
      event.stopPropagation();
      var routes = this.$.routes;
      routes.fire('route', event.detail);
    },

    '/admin/collections/new': function (event) {
      event.stopPropagation();
      var routes = this.$.routes;
      event.detail.data = { collection: {} };
      routes.fire('route', event.detail);
    },

    '/admin/collections/:collection_id': function (event) {
      event.stopPropagation();
      var routes = this.$.routes;
      var model_id = event.detail.params.collection_id;
      this.get_model({
        collection: 'collections',
        modelId: model_id,
        include:Â ['products']
      }, function (err, model) {
        if (err) {
          event.detail.page_name = '404';
        } else {
          event.detail.data = { collection: model };
        }
        routes.fire('route', event.detail);
      });
    },

    '/admin/customers/new': function (event) {
      event.stopPropagation();
      var routes = this.$.routes;
      event.detail.data = { customer: {} };
      routes.fire('route', event.detail);
    },

    '/admin/customers/:customer_id': function (event) {
      event.stopPropagation();
      var routes = this.$.routes;
      var model_id = event.detail.params.customer_id;
      this.get_model({
        collection: 'customers',
        modelId: model_id
      }, function (err, model) {
        if (err) {
          event.detail.page_name = '404';
        } else {
          event.detail.data = { customer: model };
        }
        routes.fire('route', event.detail);
      });
    },

    '/admin/products': function (event) {
      event.stopPropagation();
      var routes = this.$.routes;
      routes.fire('route', event.detail);
    },

    '/admin/products/new': function (event) {
      event.stopPropagation();
      var routes = this.$.routes;
      event.detail.data = { product: {} };
      routes.fire('route', event.detail);
    },

    '/admin/products/:product_id': function (event) {
      event.stopPropagation();
      var routes = this.$.routes;
      var model_id = event.detail.params.product_id;
      this.get_model({
        collection: 'products',
        modelId: model_id,
        include: ['collections', 'product_type', 'vendor', 'images']
      }, function (err, model) {
        if (err) {
          event.detail.page_name = '404';
        } else {
          event.detail.data = { product: model };
        }
        routes.fire('route', event.detail);
      });
    },


    '/admin/products/:product_id/variants': function (event) {
      event.stopPropagation();
      var routes = this.$.routes;
      var model_id = event.detail.params.product_id;
      this.get_model({
        collection: 'products',
        modelId: model_id,
        include: ['options', 'variants']
      }, function (err, model) {
        if (err) {
          event.detail.page_name = '404';
        } else {
          event.detail.data = { product: model };
        }
        routes.fire('route', event.detail);
      });
    },

    '/admin/products/:product_id/variants/:variant_id': function (event) {
      event.stopPropagation();
      var routes = this.$.routes;
      var model_id = event.detail.params.variant_id;
      this.get_model({
        collection: 'product_variants',
        modelId: model_id,
        include: ['product']
      }, function (err, model) {
        if (err) {
          event.detail.page_name = '404';
        } else {
          event.detail.data = { variant: model };
        }
        routes.fire('route', event.detail);
      });
    },

    '/admin/orders/new': function (event) {
      event.stopPropagation();
      var routes = this.$.routes;
      event.detail.data = { order: {} };
      routes.fire('route', event.detail);
    },

    '/admin/orders/:order_id': function (event) {
      event.stopPropagation();
      var routes = this.$.routes;
      var model_id = event.detail.params.order_id;
      this.get_model({
        collection: 'orders',
        modelId: model_id,
        include: ['order_items', 'customer']
      }, function (err, model) {
        if (err) {
          event.detail.page_name = '404';
        } else {
          event.detail.data = { order: model };
        }
        routes.fire('route', event.detail);
      });
    },

    get_model: function (params, callback) {
      var api = document.createElement('api-model-get');

      api.collection = params.collection;
      api.modelId = params.modelId;
      api.include = params.include || [];
      // api.accessToken = accessToken;

      api.addEventListener('response', function (event) {
        callback(null, api.response);
      }, true);

      api.addEventListener('error', function (event) {
        callback(api.error, null);
      }, true);

      api.send();
    }

  });
</script>