<link rel="import" href="/components/app-routes/app-routes.html">
<link rel="import" href="/components/app-route/app-route.html">
<link rel="import" href="/components/app-container/app-container.html">
<link rel="import" href="/components/app-link/app-link.html">
<link rel="import" href="/components/app-session/app-session.html">
<link rel="import" href="/components/api-model-get/api-model-get.html">
<link rel="import" href="/components/api-model-find/api-model-find.html">
<link rel="import" href="../app-theme/app-theme.html">
<link rel="import" href="../page-home/page-home.html">
<link rel="import" href="../page-collections/page-collections.html">
<link rel="import" href="../page-collection/page-collection.html">
<link rel="import" href="../page-orders/page-orders.html">
<link rel="import" href="../page-order/page-order.html">
<link rel="import" href="../page-products/page-products.html">
<link rel="import" href="../page-product/page-product.html">
<link rel="import" href="../page-customers/page-customers.html">
<link rel="import" href="../page-customer/page-customer.html">
<link rel="import" href="../page-variants/page-variants.html">
<link rel="import" href="../page-variant/page-variant.html">

<link rel="import" href="../page-test/page-test.html">
<dom-module id="app-boot">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>

    <app-session id="session"></app-session>

    <app-container id="app" on-login="on_login" on-logout="on_logout"></app-container>

    <app-routes id="routes" on-route="on_route">

      <app-route path="/admin" page="page-home"></app-route>
      <app-route path="/admin/" page="page-home"></app-route>
      <app-route path="/admin/collections" page="page-collections"></app-route>
      <!-- <app-route path="/admin/collections/new" page="page-collection"></app-route> -->
      <app-route path="/admin/collections/:collection_id" page="page-collection"
        on-route="/admin/collections/:collection_id"></app-route>
      <app-route path="/admin/orders" page="page-orders"
        on-route="/admin/orders">
      </app-route>
      <!-- <app-route path="/admin/orders/new" page="page-order"></app-route> -->
      <app-route path="/admin/orders/:order_id" page="page-order"
        on-route="/admin/orders/:order_id"></app-route>


      <app-route path="/admin/products" page="page-products"
        on-route="/admin/products">
        </app-route>
      <app-route path="/admin/products/new" page="page-product"
        on-route="/admin/products/new">
      </app-route>
      <app-route path="/admin/products/:product_id" page="page-product"
        on-route="/admin/products/:product_id"></app-route>

      <app-route path="/admin/customers" page="page-customers"
        on-route="/admin/customers">
      </app-route>
      <app-route path="/admin/customers/new" page="page-customer"
        on-route='/admin/customers/new'></app-route>
      <app-route path="/admin/customers/:customer_id" page="page-customer"
        on-route="/admin/customers/:customer_id"></app-route>
       <!--varianti di un prodotto-->
      <app-route path="/admin/products/:product_id/variants" page="page-variants"
        on-route="/admin/products/:product_id/variants">
      </app-route>
      <!--scheda variante-->
      <app-route path="/admin/products/:product_id/variants/:variant_id" page="page-variant"
        on-route="/admin/products/:product_id/variants/:variant_id">
      </app-route>

      <app-route path="/admin/test" page="page-test"></app-route>
    </app-routes>

  </template>
</dom-module>
<script>


  Polymer({

    is: 'app-boot',

    properties: {
      user: {
        type: Object
      }
    },

    on_route: function (event) {
      this.user = this.$.session.get('user');
    },

    on_login: function (event) {
      this.$.session.set('user', event.detail.user);
    },

    on_logout: function (event) {
      this.$.session.unset('user');
    },

    '/login': function (event) {
      if (this.user) {
        event.stopPropagation();
        page('/');
        return;
      }
    },

    '/admin/products/new': function (event) {
      event.stopPropagation();
      var routes = this.$.routes;
      event.detail.data = { product: {} };
      routes.fire('route', event.detail);
    },

    '/admin/customers/new': function (event) {
      event.stopPropagation();
      var routes = this.$.routes;
      event.detail.data = { customer: {} };
      routes.fire('route', event.detail);
    },


    '/admin/collections/:collection_id': function (event) {
      event.stopPropagation();
      var routes = this.$.routes;
      var model_id = event.detail.params.collection_id;
      this.get_model({
        collection: 'collections',
        modelId: model_id,
        include: ['products']
      }, function (err, model) {
        if (err) {
          event.detail.page_name = '404';
        } else {
          event.detail.data = { collection: model };
        }
        routes.fire('route', event.detail);
      });
    },

    '/admin/customers': function (event) {
      event.stopPropagation();
      var routes = this.$.routes;
      this.get_models({
          collection: 'customers'
      }, function (err, models) {
        if (err) {
          event.detail.page_name = '404';
        } else {
          event.detail.data = { customers: models };
        }
        routes.fire('route', event.detail);
      });
    },

    '/admin/customers/:customer_id': function (event) {
      event.stopPropagation();
      var routes = this.$.routes;
      var model_id = event.detail.params.customer_id;
      this.get_model({
        collection: 'customers',
        modelId: model_id
      }, function (err, model) {
        if (err) {
          event.detail.page_name = '404';
        } else {
          event.detail.data = { customer: model };
        }
        routes.fire('route', event.detail);
      });
    },

    '/admin/products/:product_id/variants': function (event) {
      event.stopPropagation();
      var routes = this.$.routes;
      var model_id = event.detail.params.product_id;
      this.get_model({
        collection: 'products',
        modelId: model_id,
        include: ['options', 'variants']
      }, function (err, model) {
        if (err) {
          event.detail.page_name = '404';
        } else {
          event.detail.data = { product: model };
        }
        routes.fire('route', event.detail);
      });
    },

    '/admin/products/:product_id/variants/:variant_id': function (event) {
      event.stopPropagation();
      var routes = this.$.routes;
      var model_id = event.detail.params.product_id;
      this.get_model({
        collection: 'products',
        modelId: model_id,
        include: ['variants']
      }, function (err, model) {
        if (err) {
          event.detail.page_name = '404';
        } else {
          event.detail.data = { product: model };
        }
        routes.fire('route', event.detail);
      });
    },

    '/admin/products': function (event) {
      event.stopPropagation();
      var routes = this.$.routes;
      this.get_models({
          collection: 'products'
      }, function (err, models) {
        if (err) {
          event.detail.page_name = '404';
        } else {
          console.log();
          event.detail.data = { products: models };
        }
        routes.fire('route', event.detail);
      });
    },

    '/admin/products/:product_id': function (event) {
      event.stopPropagation();
      var routes = this.$.routes;
      var model_id = event.detail.params.product_id;
      this.get_model({
        collection: 'products',
        modelId: model_id,
        include: ['collections', 'product_type', 'vendor']
      }, function (err, model) {
        if (err) {
          event.detail.page_name = '404';
        } else {
          event.detail.data = { product: model };
        }
        routes.fire('route', event.detail);
      });
    },

    '/admin/orders': function (event) {
      event.stopPropagation();
      var routes = this.$.routes;
      this.get_models({
          collection: 'orders'
      }, function (err, models) {
        if (err) {
          event.detail.page_name = '404';
        } else {
          event.detail.data = { orders: models };
        }
        routes.fire('route', event.detail);
      });
    },

    '/admin/orders/:order_id': function (event) {
      event.stopPropagation();
      var routes = this.$.routes;
      var model_id = event.detail.params.order_id;
      this.get_model({
        collection: 'orders',
        modelId: model_id,
        include: ['order_items', 'customer']
      }, function (err, model) {
        if (err) {
          event.detail.page_name = '404';
        } else {
          event.detail.data = { order: model };
        }
        routes.fire('route', event.detail);
      });
    },

    get_model: function (params, callback) {
      var api = document.createElement('api-model-get');

      api.collection = params.collection;
      api.modelId = params.modelId;
      api.include = params.include || [];
      // api.accessToken = accessToken;

      api.addEventListener('complete', function (event) {
        callback(event.detail.error, event.detail.response);
      });
      api.send();
    },

    get_models: function (params, callback) {
      var api = document.createElement('api-model-find');

      api.collection = params.collection;
      api.include = params.include || [];
      // api.accessToken = accessToken;

      api.addEventListener('complete', function (event) {
        callback(event.detail.error, event.detail.response);
      });
      api.send();
    }

  });
</script>