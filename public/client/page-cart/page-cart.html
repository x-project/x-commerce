<link rel="import" href="../layout-client/layout-client.html">
<link rel="import" href="../part-date/part-date.html">
<link rel="import" href="../part-jumbotron/part-jumbotron.html">
<link rel="import" href="../style-page/style-page.html">
<link rel="import" href="part-cart-order-items.html">
<link rel="import" href="part-cart-order-detail.html">
<dom-module id="page-cart">
  <template>
    <style include="style-page"></style>

    <app-session id="session"></app-session>

    <api-model-find id="find_products" collection="products" response="{{products}}"
      on-response="on_response_find_products">
    </api-model-find>

    <api-model-find id="find_variants" collection="product_variants" response="{{variants}}"
      on-response="on_response_find_variants">
    </api-model-find>

    <iron-ajax id="create_order" method="PUT" handle-as="json" url="/api/orders"
      content-type="application/json" on-response="on_response_create_order" on-error="on_error">
    </iron-ajax>

    <iron-ajax id="create_order_items" method="POST" handle-as="json" content-type="application/json"
      on-response="on_response_create_order_items" on-error="on_error">
    </iron-ajax>

    <layout-client>
      <part-jumbotron class="jumbotron">
        <h1>Cart</h1>
      </part-jumbotron>
      <div class="container">
        <part-cart-order-items cart="{{cart}}" on-update-cart="on_update_cart"></part-cart-order-items>
        <part-cart-order-detail id="order_detail" cart="{{cart}}"
          on-try-create-order="on_try_create_order">
        </part-cart-order-detail>
        <!-- <part-cart-checkout ></part-cart-checkout> -->
      </div>
    </layout-client>

  </template>
</dom-module>
<script>
  Polymer({

    is: 'page-cart',

    properties: {
      products: {
        type: Array,
        value: function () { return {}; }
      },
      variants: {
        type: Array,
        value: function () { return {}; }
      },
      order: {
        type: Object,
        value: function () { return {}; }
      }
    },

    attached: function () {
      this.find_products();
    },

    find_products: function () {
      var cart = this.$.session.get('cart');
      var ids = this.pluck(cart, 'product_id');
      this.$.find_products.where = {'id': {'inq': ids }};
      this.$.find_products.send();
    },

    on_response_find_products: function (event) {
      event.stopPropagation();
      this.find_variants();
    },

    find_variants: function () {
      var cart = this.$.session.get('cart');
      var ids = this.pluck(cart, 'product_variant_id');
      this.$.find_variants.where = {'id': {'inq': ids }};
      this.$.find_variants.send();
    },

    on_response_find_variants: function (event) {
      event.stopPropagation();
      this.populate_cart();
    },

    populate_cart: function () {
      var cart = this.$.session.get('cart');
      cart.forEach(function (item) {
        this.products.forEach( function (product) {
          if (product.id === item.product_id) {
            item.product = product;
          }
        });
        this.variants.forEach(function (variant) {
          if (variant.id === item.product_variant_id) {
            item.variant = variant;
          }
        });
      }, this);
      this.$.session.set('cart', cart);
      this.cart =  cart;
    },

    pluck: function (array, key) {
      return array.filter(function (item) {
        return item[key] !== '';
      }).map(function (item) {
        return item[key];
      });
    },

    on_remove_cart: function () {
      this.$.session.set('cart', this.cart);
    },

    on_try_create_order: function (event) {
      if (this.$.session.get('user')) {
        this.try_create_order();
      }
      else {
        page('/signup');
      }
    },

    try_create_order: function () {
      var customer_id = this.$.session.get('user').id;
      this.$.create_order.body = JSON.stringify({ customer_id: customer_id });
      this.$.create_order.generateRequest();
    },

    on_response_create_order: function (event) {
      event.stopPropagation();
      this.order = event.detail.response;
      this.$.create_order_items.url = '/api/orders/' + this.order.id + '/order_items';
      this.$.create_order_items.body = this.get_order_items();
      this.$.create_order_items.generateRequest();
    },

    get_order_items: function () {
      var order_items = [];
      var cart = this.$.session.get('cart');
      var temp;
      cart.forEach( function (item) {
        temp = {};
        temp.order_id = this.order.id;
        temp.product_id = item.product_id;
        temp.product_variant_id = item.product_variant_id;
        temp.quantity = item.quantity;
        order_items.push(temp);
      }, this);
      return JSON.stringify(order_items);
    },

    on_response_create_order_items: function (event) {
      event.stopPropagation();
      page('/cart/orders/'+ this.order.id);
    },

    on_update_cart: function (event) {
      event.stopPropagation();
      this.$.session.set('cart', this.cart);
      this.$.order_detail.update_subtotal();
    },

    on_error: function (event) {
      event.stopPropagation();
      console.log(event);
    }

  });
</script>