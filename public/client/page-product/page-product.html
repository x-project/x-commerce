<link rel="import" href="../../components/app-link/app-link.html">
<link rel="import" href="../layout-client/layout-client.html">
<link rel="import" href="../part-jumbotron/part-jumbotron.html">
<link rel="import" href="part-product-cart.html">
<link rel="import" href="part-product-comments.html">
<link rel="import" href="part-product-info.html">
<link rel="import" href="part-product-images.html">
<link rel="import" href="part-product-details.html">
<link rel="import" href="part-product-options.html">
<link rel="import" href="part-product-type.html">
<link rel="import" href="part-product-vendor.html">
<dom-module id="page-product">
  <template>
    <style include="style-page"></style>

    <app-session id="session"></app-session>

    <layout-client>
      <part-jumbotron class="jumbotron">
        <h1><span>Product</span> <span>{{data.product.title}}</span></h1>
      </part-jumbotron>
      <div class="container">
        <a is="app-link" href="/products">Back to products</a>
        <a is="app-link" href="{{review}}">feedback</a>
        <part-product-info product="{{data.product}}"></part-product-info>
        <part-product-type product="{{data.product}}"></part-product-type>
        <part-product-options product="{{data.product}}" on-add-variant="on_add_variant">
          </part-product-options>
        <part-product-vendor product="{{data.product}}"></part-product-vendor>
        <part-product-images product="{{data.product}}"></part-product-images>
        <part-product-details product="{{data.product}}"></part-product-details>
        <part-product-cart on-try-add-cart="on_try_add_cart"></part-product-cart>
        <part-product-comments product="{{data.product}}"></part-product-comments>
      </div>
    </layout-client>

  </template>
</dom-module>
<script>
  Polymer({

    is: 'page-product',

    properties: {
      data: {
        type: Object,
        value: function () { return {}; }
      },
      options_variant: {
        type: Array,
        value: function () { return []; }
      }
    },

    attached: function () {
      this.review = '/products/' + this.data.product.id + '/review';
      if (this.data.product.variants.length > 0) {
        this.get_default_variant();
      }
    },

    on_add_variant: function (event) {
      event.stopPropagation();
      var new_option = event.detail;
      this.update_variant(new_option);
    },

    update_variant: function (new_option) {
      var test= false;
      for(var i = 0; i<this.options_variant.length && !test; i++) {
        if (this.options_variant[i].name === new_option.name) {
          this.options_variant[i].value = new_option.value;
          test = true;
        }
      }
    },

    on_try_add_cart: function (event) {
      event.stopPropagation();
      var my_products = JSON.parse(this.$.session.get('my_cart'));
      if (this.data.product.variants.length == 0) {
        if (this.exists(my_products, this.data.product, null))
          this.update_quantity (my_products, this.data.product, null);
        else
          my_products.push({ product: this.data.product, quantity: 1 });
        this.$.session.set('my_cart', JSON.stringify(my_products));
        console.log(JSON.parse(this.$.session.get('my_cart')));
        return;
      }
      if (this.data.product.variants.length > 0) {
        var variant = this.get_variant();
        if (this.exists(my_products, this.data.product, variant))
          this.update_quantity(my_products, this.data.product, variant);
        else
          my_products.push({ product: this.data.product, variant: variant, quantity: 1 });
        this.$.session.set('my_cart', JSON.stringify(my_products));
        console.log(JSON.parse(this.$.session.get('my_cart')));
        return;
      }

      // console.log(JSON.parse(this.$.session.get('my_cart')));
      // my_products = [];
      // this.$.session.set('my_cart', JSON.stringify(my_products));
      // console.log(JSON.parse(this.$.session.get('my_cart')));

    },

    update_quantity: function (my_products, product, variant) {
      var test= false;
      if (variant == null) {
        for(var i = 0; i < my_products.length && !test; i++) {
          if (my_products[i].product.id == product.id) {
            my_products[i].quantity++;
            test = true;
          }
        }
        return;
      }
      var check = false;
      for(var i = 0; i < my_products.length && !check; i++) {
        if (my_products[i].product.id == product.id && my_products[i].variant.id == variant.id) {
          my_products[i].quantity++;
          check = true;
        }
      }
    },

    get_variant: function () {
      var test= false;
      var variant;
      var variant_name = this.get_variant_name_from_option();
      for(var i = 0; i<this.data.product.variants.length && !test; i++) {
        if (this.data.product.variants[i].name === variant_name) {
          variant = this.data.product.variants[i];
          test = true;
        }
      }
      return variant;
    },

    get_variant_name_from_option: function () {
      var options = [];
      this.options_variant.forEach(function (option) {
        options.push(option.value);
      });
      return options.join('-');
    },

    get_default_variant: function () {
      var list_option = [];
      this.data.product.options.forEach( function (option_item) {
        var option = {};
        option.name = option_item.name;
        option.value = option_item.values[0];
        list_option.push(option);
      });
      this.options_variant = list_option;
    },

    get_quantity: function (my_products, variant) {
      var count = 0;
      var curr_prod = this.data.product;
      if(variant == null) {
        my_products.forEach(function (obj_product) {
          if (obj_product.product.id === curr_prod.id) {
            count++;
          }
        });
        return count;
      }
      //variant count
      my_products.forEach(function (obj_product_variant) {
        if(obj_product_variant.hasOwnProperty('variant'))
          if (obj_product_variant.variant.name === variant.name) {
            count++;
          }
      });
      return count;
    },

    exists: function (my_products, product, variant) {
      if (variant == null) {
        return my_products.some(function (obj_product_variant) {
          if(obj_product_variant.product.id == product.id)
            return true;
        });
      }
      return my_products.some(function (obj_product_variant) {
        if(obj_product_variant.product.id == product.id && obj_product_variant.variant.id == variant)
          return true;
      });
    }
  });
</script>
