<link rel="import" href="../../components/api-model/api-model.html">
<link rel="import" href="../../components/app-container/app-container.html">
<link rel="import" href="../../components/app-link/app-link.html">
<link rel="import" href="../../components/app-route/app-route.html">
<link rel="import" href="../../components/app-routes/app-routes.html">
<link rel="import" href="../../elements/router-behaviour/router-behaviour.html">
<link rel="import" href="../app-theme/app-theme.html">
<link rel="import" href="../page-404/page-404.html">
<link rel="import" href="../page-about/page-about.html">
<link rel="import" href="../page-cart/page-cart.html">
<link rel="import" href="../page-contact/page-contact.html">
<link rel="import" href="../page-forgot/page-forgot.html">
<link rel="import" href="../page-home/page-home.html">
<link rel="import" href="../page-login/page-login.html">
<link rel="import" href="../page-order/page-order.html">
<link rel="import" href="../page-privacy/page-privacy.html">
<link rel="import" href="../page-product/page-product.html">
<link rel="import" href="../page-products/page-products.html">
<link rel="import" href="../page-reset/page-reset.html">
<link rel="import" href="../page-review/page-review.html">
<link rel="import" href="../page-reviews/page-reviews.html">
<link rel="import" href="../page-settings/page-settings.html">
<link rel="import" href="../page-signup/page-signup.html">
<link rel="import" href="../page-test/page-test.html">
<dom-module id="app-boot">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>

    <app-container id="app" on-login="on_login"></app-container>

  </template>
</dom-module>
<script>
  Polymer({

    is: 'app-boot',

    behaviors: [
      Polymer.RouterBehaviour
    ],

    on_login: function (event) {
      this.session.set('user', event.detail.user);
      this.session.set('token', event.detail.id);
    },

    open_static_page: function (context) {
      this.init(context)
        .then(function (context) {
          return this.find_models({
            collection: 'stores',
            one: true
          });
        }.bind(this))
        .then(function (store) {
          context.data.store = store;
          this.open_page(context);
        }.bind(this))
        .catch(function (error) {
          context.page_name = 'page-404';
          context.data.error = error;
          this.open_page(context);
        })
    },

    '/': function (context) {
      context.page_name = 'page-home';
      this.open_static_page(context);
    },

    '/test': function (context) {
      context.page_name = 'page-test';
      this.open_page(context);
    },

    '/home': function (context) {
      context.page_name = 'page-home';
      this.open_static_page(context);
    },

    '/about': function (context) {
      context.page_name = 'page-about';
      this.open_static_page(context);
    },

    '/contact': function (context) {
      context.page_name = 'page-contact';
      this.open_static_page(context);
    },

    '/privacy': function (context) {
      context.page_name = 'page-privacy';
      this.open_static_page(context);
    },

    '/cart': function (context) {
      context.page_name = 'page-cart';
      this.open_static_page(context);
    },

    '/products': function (context) {
      context.page_name = 'page-products';
      this.open_static_page(context);
    },

    '/reviews': function (context) {
      context.page_name = 'page-reviews';
      this.open_static_page(context);
    },

    '/orders': function (context) {
      context.page_name = 'page-order';
      this.open_static_page(context);
    },

    '/reviews/:review_id': function (context) {
      var promise = this.init(context)


      promise.then(function () {
          return this.get_model({
            collection: 'reviews',
            modelId: context.params.review_id,
            include: ['customer', 'product']
          });
        }.bind(this))
        .then(function (model) {
          context.page_name = 'page-review';
          context.data = {};
          context.data.review = model;
          this.open_page(context);
        }.bind(this))
        .catch(function (err) {
          context.page_name = 'page-404';
          this.open_page(context);
        });
    },

    '/products/:product_id': function (context) {
      this.get_model({
        collection: 'products',
        modelId: context.params.product_id,
        include: ['images', 'product_type', 'variants', 'vendor']
      })
      .then(function (model) {
        context.page_name = 'page-product';
        context.data = {};
        context.data.product = model;
        this.open_page(context);
      }.bind(this))
      .catch(function (err) {
        context.page_name = 'page-404';
        this.open_page(context);
      });
    },

    '/login': function (context) {
      context.page_name = 'page-login';
      this.open_static_page(context);
    },

    '/signup': function (context) {
      context.page_name = 'page-signup';
      this.open_static_page(context);
    },

    '/forgot': function (context) {
      context.page_name = 'page-forgot';
      this.open_static_page(context);
    },

    '/reset': function (context) {
      context.page_name = 'page-reset';
      this.open_static_page(context);
    },

    '/settings': function (context) {
      context.page_name = 'page-settings';
      this.open_static_page(context);
    },

    '/*': function (context) {
      page('/');
    }

  });
</script>