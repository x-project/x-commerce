<link rel="import" href="/components/app-routes/app-routes.html">
<link rel="import" href="/components/app-route/app-route.html">
<link rel="import" href="/components/app-container/app-container.html">
<link rel="import" href="/components/app-link/app-link.html">
<link rel="import" href="/components/app-session/app-session.html">
<link rel="import" href="/components/iron-ajax/iron-ajax.html">
<link rel="import" href="../app-theme/app-theme.html">
<link rel="import" href="../page-home/page-home.html">
<link rel="import" href="../page-about/page-about.html">
<link rel="import" href="../page-contact/page-contact.html">
<link rel="import" href="../page-privacy/page-privacy.html">
<link rel="import" href="../page-cart/page-cart.html">
<link rel="import" href="../page-product/page-product.html">
<link rel="import" href="../page-products/page-products.html">
<link rel="import" href="../page-404/page-404.html">
<link rel="import" href="../page-test/page-test.html">
<dom-module id="app-boot">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>

    <app-session id="session"></app-session>

    <app-container id="app"></app-container>

  </template>
</dom-module>
<script>
  Polymer({

    is: 'app-boot',

    ready: function () {
      this.register();
    },

    register: function () {
      var app = this;
      Object.keys(app.constructor.prototype)
        .filter(function (method) {
          return method.indexOf('/') == 0;
        })
        .forEach(function (method) {
          var handler = app[method].bind(this);
          page(method, handler);
        }, this);
      page();
    },

    get_model: function (params) {
      var request = document.createElement('api-model-get');
      request.collection = params.collection;
      request.modelId = params.modelId;
      request.include = params.include || [];

      return new Promise(function (resolve, reject) {
        request.addEventListener('response', function (event) {
          resolve(request.response);
        }, true);
        request.addEventListener('error', function (event) {
          reject(request.error);
        }, true);
        request.send();
      });
    },

    open_page: function (context) {
      var element = document.createElement(context.page_name);
      element.params = context.params;
      element.data = context.data;
      this.$.app.open(element);
    },

    '/': function (context) {
      context.page_name = 'page-home';
      this.open_page(context);
    },

    '/test': function (context) {
      context.page_name = 'page-test';
      this.open_page(context);
    },

    '/home': function (context) {
      context.page_name = 'page-home';
      this.open_page(context);
    },

    '/about': function (context) {
      context.page_name = 'page-about';
      this.open_page(context);
    },

    '/contact': function (context) {
      context.page_name = 'page-contact';
      this.open_page(context);
    },

    '/privacy': function (context) {
      context.page_name = 'page-privacy';
      this.open_page(context);
    },

    '/cart': function (context) {
      context.page_name = 'page-cart';
      this.open_page(context);
    },

    '/products': function (context) {
      context.page_name = 'page-products';
      this.open_page(context);
    },

    '/products/:product_id': function (context) {
      this.get_model({
        collection: 'products',
        modelId: context.params.product_id,
        include: ['comments', 'images', 'product_type', 'variants', 'vendor']
      })
      .then(function (model) {
        context.page_name = 'page-product';
        context.data = {};
        context.data.product = model;
        this.open_page(context);
      }.bind(this))
      .catch(function (err) {
        context.page_name = 'page-404';
        this.open_page(context);
      });
    },

    '/*': function (context) {
      page('/');
    }

  });
</script>